<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password Validation</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.2/firebase-database.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>Password Validation</h1>
    <form id="loginForm">
        <input type="text" id="username" placeholder="Username" required><br>
        <input type="password" id="password" placeholder="Password" required><br>
        <button type="submit">Log In</button>
    </form>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCduVWKA570X-7cnLCvYlZS13sGNZoH8sM",
            authDomain: "passwordcheckapp.firebaseapp.com",
            databaseURL: "https://passwordcheckapp-default-rtdb.firebaseio.com",
            projectId: "passwordcheckapp",
            storageBucket: "passwordcheckapp.firebasestorage.app",
            messagingSenderId: "104974080268",
            appId: "1:104974080268:web:5662a4b41a6dab3afe9129",
            measurementId: "G-TXPZJHY4MY"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database(app);

        // GitHub token for API requests
        const token = "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";
        const repoOwner = "qweujsakdwqesad";  // Your repo owner
        const repoName = "qweujsakdwqesad.github.io";  // Your repository name
        const bannedFilePath = "banned-users.json";  // Path to your banned users file

        async function checkAndBanUser(username) {
            // Fetch the user's details from Firebase
            const userRef = firebase.database().ref(`users/${username}`);
            const userSnapshot = await userRef.once("value");

            if (!userSnapshot.exists()) {
                alert("User does not exist.");
                return;
            }

            const userData = userSnapshot.val();
            const deviceId = userData.deviceId; // Fetch the deviceId of the user

            // Get current banned users from GitHub
            await $.get(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${bannedFilePath}`, {
                headers: {
                    Authorization: `token ${token}`
                }
            }).then(async (response) => {
                const fileContent = atob(response.content);
                let bannedUsers = JSON.parse(fileContent);
                const userAlreadyBanned = bannedUsers.some(bannedUser => bannedUser.deviceId === deviceId);

                if (userAlreadyBanned) {
                    alert("You are banned.");
                    return;
                }

                // Check if the password is correct
                if (userData.password !== $("#password").val()) {
                    // Add user to banned list if the password is incorrect
                    bannedUsers.push({ deviceId: deviceId, username: username });

                    // Update the banned-users file on GitHub
                    await $.ajax({
                        url: `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${bannedFilePath}`,
                        method: 'PUT',
                        headers: {
                            Authorization: `token ${token}`
                        },
                        data: JSON.stringify({
                            message: "Ban user due to invalid password attempt",
                            content: btoa(JSON.stringify(bannedUsers)),
                            sha: response.sha // The SHA from the previous file request
                        }),
                        success: () => {
                            alert("You have been banned.");
                            window.location.reload();  // Reload the page after banning
                        },
                        error: (err) => {
                            console.error("Error updating banned-users.json: ", err);
                        }
                    });
                } else {
                    // Let the user in if the password is correct and deviceId matches
                    alert("Login successful.");
                    // Redirect to a dashboard or another page after successful login
                    window.location.href = "/Website.html";  // Replace with your desired URL
                }
            }).catch((error) => {
                console.error("Error fetching banned-users.json: ", error);
            });
        }

        $("#loginForm").submit(function(event) {
            event.preventDefault();

            const username = $("#username").val();
            const password = $("#password").val();

            // Call the function to check and ban the user
            checkAndBanUser(username);
        });
    </script>
</body>
</html>
