<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login</title>
</head>
<body>
    <h2>Login</h2>
    <input type="text" id="nameInput" placeholder="Enter your name" />
    <input type="password" id="passwordInput" placeholder="Enter your password" />
    <button onclick="checkName()">Login</button>
    <p id="message"></p>

   <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
  import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";
  import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-functions.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCduVWKA570X-7cnLCvYlZS13sGNZoH8sM",
    authDomain: "passwordcheckapp.firebaseapp.com",
    databaseURL: "https://passwordcheckapp-default-rtdb.firebaseio.com",
    projectId: "passwordcheckapp",
    storageBucket: "passwordcheckapp.firebasestorage.app",
    messagingSenderId: "104974080268",
    appId: "1:104974080268:web:5662a4b41a6dab3afe9129",
    measurementId: "G-TXPZJHY4MY"
  };
  
  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const database = getDatabase(app);
  const functions = getFunctions(app);

  // Attach checkName function to window
  window.checkName = async function() {
  const nameInput = document.getElementById("nameInput").value;
            const passwordInput = document.getElementById("passwordInput").value;
            const messageElement = document.getElementById("message");

            // Generate a unique device ID and store it in localStorage
            let deviceId = localStorage.getItem("device_id");
            if (!deviceId) {
                deviceId = 'device-' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem("device_id", deviceId);
            }

            try {
                console.log("Fetching name.json...");
                const response = await fetch('/name.json');
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

                const validPasswords = await response.json();
                if (validPasswords[nameInput] === passwordInput) {
                    // Check if the device has already been banned
                    const bannedResponse = await fetch('/banned-users.json');
                    const bannedUsers = await bannedResponse.json();

                    if (bannedUsers.includes(deviceId)) {
                        messageElement.textContent = "You are banned from logging in.";
                        return;
                    }

                    // Check if the device has already been used to log in
                    const deviceRef = firebase.database().ref(`users/${nameInput}/deviceId`);
                    const snapshot = await deviceRef.get();

                    if (snapshot.exists() && snapshot.val() !== deviceId) {
                        alert("Well well well, You shared your password. Access revoked.");
                        
                        // Add the device ID to banned-users.json
                        const updateResponse = await fetch('https://api.github.com/repos/qweujsakdwqesad/qweujsakdwqesad.github.io/contents/banned-users.json', {
                            method: 'PUT',
                            headers: {
                                Authorization: 'token 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', // Replace with your GitHub token
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                message: 'Ban device for sharing password',
                                content: btoa(JSON.stringify([...bannedUsers, deviceId])),
                                sha: 'e5eac7b07e498ead10ecdb0af573737508d9c6a1' // Replace with the SHA of the banned-users.json file
                            })
                        });

                        if (updateResponse.ok) {
                            alert("Your device is now banned.");
                            window.location.href = "index.html"; // Redirect to login page
                        }

                        await firebase.database().ref(`users/${nameInput}`).remove();
                        return;
                    }

                    // Store the device ID in Firebase if itâ€™s the first login on this device
                    await deviceRef.set(deviceId);
                    console.log("Credentials match! Redirecting...");
                    sessionStorage.setItem("name", nameInput);
                    sessionStorage.setItem("password", passwordInput);
                    window.location.href = "Website.html";
                } else {
                    messageElement.textContent = "Incorrect name or password.";
                }
            } catch (error) {
                console.error("Error loading name.json:", error);
                messageElement.textContent = "Error loading credentials. Please try again later.";
            }
        }
      
            
    </script>
</body>
</html>
